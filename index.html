<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculus Mage: ‡∏®‡∏∂‡∏Å‡∏´‡∏≠‡∏Ñ‡∏≠‡∏¢‡∏™‡∏∏‡πà‡∏°‡∏Ñ‡∏±‡∏°‡∏†‡∏µ‡∏£‡πå</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&family=Mitr:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <style>
        :root {
            --bg-dark: #0f0524;
            --bg-light: #250a47;
            --magic-purple: #a55eea;
            --gold: #fed330;
            --white: #ffffff;
        }

        body {
            font-family: 'Kanit', sans-serif;
            background: radial-gradient(circle at center, var(--bg-light) 0%, var(--bg-dark) 100%);
            margin: 0; height: 100vh; display: flex; overflow: hidden; color: var(--white);
        }

        /* ‡∏õ‡∏∏‡πà‡∏° Share ‡∏•‡∏≠‡∏¢ */
        .btn-share-float {
            position: fixed; top: 20px; right: 20px;
            background: rgba(165, 94, 234, 0.3); border: 1px solid var(--magic-purple);
            color: white; padding: 10px 15px; border-radius: 50px;
            cursor: pointer; z-index: 100; transition: 0.3s;
        }
        .btn-share-float:hover { background: var(--magic-purple); box-shadow: 0 0 15px var(--magic-purple); }

        #start-screen, #modal-overlay, #share-overlay {
            position: fixed; inset: 0; background: rgba(15, 5, 36, 0.98);
            z-index: 1000; display: flex; flex-direction: column;
            justify-content: center; align-items: center; text-align: center;
        }

        #share-overlay { display: none; z-index: 2100; background: rgba(0,0,0,0.9); }

        .magic-title {
            font-family: 'Mitr', sans-serif; font-size: 3.5rem;
            color: var(--gold); text-shadow: 0 0 30px var(--magic-purple);
        }

        .qr-container {
            background: white; padding: 20px; border-radius: 15px;
            margin: 20px auto; border: 5px solid var(--gold);
        }

        .btn-magic {
            background: linear-gradient(45deg, #8854d0, #a55eea);
            color: white; border: 2px solid var(--gold);
            padding: 12px 40px; font-size: 20px;
            border-radius: 50px; cursor: pointer;
            box-shadow: 0 0 20px var(--magic-purple);
            transition: 0.3s; margin: 10px;
        }

        #ladder-panel {
            width: 250px; background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px); display: flex;
            flex-direction: column-reverse; padding: 10px;
            border-right: 2px solid var(--magic-purple); overflow-y: auto;
        }

        .step {
            height: 30px; margin: 3px 0; background: rgba(255,255,255,0.05);
            display: flex; align-items: center; padding: 0 15px;
            border-radius: 5px; font-size: 0.85rem;
        }

        .step.active { background: var(--magic-purple); color: var(--gold); transform: scale(1.05) translateX(10px); }

        #main-game { flex: 1; display: flex; align-items: center; justify-content: center; }

        .quiz-card {
            background: rgba(255, 255, 255, 0.07); backdrop-filter: blur(25px);
            border: 1px solid rgba(255,255,255,0.2); width: 90%; max-width: 650px;
            border-radius: 30px; padding: 40px; text-align: center;
        }

        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 30px; }

        .opt-btn {
            padding: 18px; border: 1px solid var(--magic-purple);
            border-radius: 12px; background: rgba(255,255,255,0.05);
            color: white; font-size: 1.1rem; cursor: pointer; transition: 0.2s;
        }
        .opt-btn:hover { background: var(--magic-purple); }

        .shake { animation: shake 0.4s; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-10px); } 75% { transform: translateX(10px); } }
    </style>
</head>
<body>

    <button class="btn-share-float" onclick="openShare()">üì¢ ‡∏≠‡∏±‡∏ç‡πÄ‡∏ä‡∏¥‡∏ç‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô</button>

    <div id="share-overlay">
        <div style="background: rgba(255,255,255,0.1); padding: 30px; border-radius: 20px; border: 2px solid var(--magic-purple);">
            <h2 style="color: var(--gold);">‡∏≠‡∏±‡∏ç‡πÄ‡∏ä‡∏¥‡∏ç‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏°‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏®‡∏∂‡∏Å</h2>
            <p>‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏™‡πÅ‡∏Å‡∏ô QR Code ‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏´‡∏≠‡∏Ñ‡∏≠‡∏¢</p>
            <div id="qrcode" class="qr-container"></div>
            <p id="current-url" style="font-size: 0.8rem; opacity: 0.6; word-break: break-all; max-width: 250px; margin: 10px auto;"></p>
            <button class="btn-magic" style="font-size: 16px;" onclick="copyLink()">üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå</button>
            <button class="btn-magic" style="background: #444; border:none; font-size: 16px;" onclick="closeShare()">‡∏õ‡∏¥‡∏î</button>
        </div>
    </div>

    <div id="start-screen">
        <h1 class="magic-title">CALCULUS MAGE</h1>
        <p style="font-size: 1.2rem; color: var(--magic-purple);">‡∏´‡∏≠‡∏Ñ‡∏≠‡∏¢‡∏™‡∏∏‡πà‡∏°‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏ó‡πâ‡∏≤‡∏ó‡∏≤‡∏¢‡∏õ‡∏±‡∏ç‡∏ç‡∏≤</p>
        <button class="btn-magic" onclick="startGame()">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ú‡∏à‡∏ç‡∏†‡∏±‡∏¢</button>
        <button class="btn-magic" style="background: none; border-color: #666;" onclick="openShare()">‡πÅ‡∏ä‡∏£‡πå‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏•‡πà‡∏ô</button>
    </div>

    <div id="ladder-panel"></div>

    <div id="main-game">
        <div class="quiz-card" id="quiz-card">
            <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                <span id="level-label" style="color: var(--gold);">‡∏Ç‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà: 0/30</span>
                <span id="streak-label" style="color: #45aaf2;">Combo: 0</span>
            </div>
            <h2 id="q-text" style="min-height: 80px;">Ï§ÄÎπÑ...</h2>
            <div class="options-grid" id="options-box"></div>
        </div>
    </div>

    <div id="modal-overlay" style="display:none;">
        <div style="background: white; color: #333; padding: 40px; border-radius: 20px; width: 80%; max-width: 400px;">
            <h2 style="color: #eb4d4b;">‡∏û‡∏•‡∏≤‡∏î‡πÅ‡∏•‡πâ‡∏ß!</h2>
            <p id="correct-ans" style="font-weight: bold;"></p>
            <p id="explanation" style="font-size: 0.9rem; color: #666;"></p>
            <button class="btn-magic" onclick="closeModal()">‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏™‡∏ï‡∏¥‡πÉ‡∏´‡∏°‡πà</button>
        </div>
    </div>

    <script>
        // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏à‡∏ó‡∏¢‡πå (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á 30 ‡∏Ç‡πâ‡∏≠‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÇ‡∏Ñ‡πâ‡∏î‡∏£‡∏±‡∏ô‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏ö)
        const rawQuestions = [
            { q: "‚à´ 7 dx", options: ["7", "7x + C", "x + 7", "7x^2"], correct: 1, explain: "‚à´ k dx = kx + C" },
            { q: "‚à´ x dx", options: ["x^2", "(x^2)/2 + C", "1", "2x"], correct: 1, explain: "‚à´ x^n = x^(n+1)/(n+1)" },
            { q: "‚à´ x^2 dx", options: ["x^3/3 + C", "3x^3", "2x", "x^3"], correct: 0, explain: "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏≤‡∏£" },
            { q: "‚à´ 4x^3 dx", options: ["x^4 + C", "4x^4", "12x^2", "x^3"], correct: 0, explain: "4 * (x^4/4) = x^4" },
            { q: "‚à´ (2x+3) dx", options: ["x^2+3", "2x^2+3x", "x^2+3x + C", "5x"], correct: 2, explain: "x^2 + 3x" },
            { q: "‚à´ 1/x dx", options: ["ln|x| + C", "-1/x^2", "1", "e^x"], correct: 0, explain: "‡∏™‡∏π‡∏ï‡∏£ ln" },
            { q: "‚à´ e^x dx", options: ["xe^x", "e^x + C", "e^x+1", "ln x"], correct: 1, explain: "e^x ‡πÑ‡∏î‡πâ‡∏ï‡∏±‡∏ß‡∏°‡∏±‡∏ô‡πÄ‡∏≠‡∏á" },
            { q: "‚à´ (x^2-1) dx", options: ["x^3/3-x+C", "x^3-x", "2x", "x^3/3"], correct: 0, explain: "‡πÅ‡∏¢‡∏Å‡∏≠‡∏¥‡∏ô‡∏ó‡∏¥‡πÄ‡∏Å‡∏£‡∏ï" },
            { q: "‚à´ sin x dx", options: ["cos x", "-cos x + C", "sin x", "tan x"], correct: 1, explain: "‡πÑ‡∏î‡πâ -cos" },
            { q: "‚à´ cos x dx", options: ["sin x + C", "-sin x", "cos x", "-cos x"], correct: 0, explain: "‡πÑ‡∏î‡πâ sin" },
            { q: "‚à´‚ÇÄ¬π 2x dx", options: ["0", "1", "2", "0.5"], correct: 1, explain: "[x^2]‚ÇÄ¬π = 1" },
            { q: "‚à´‚ÇÄ¬≤ 3x^2 dx", options: ["4", "6", "8", "12"], correct: 2, explain: "[x^3]‚ÇÄ¬≤ = 8" },
            { q: "‚à´‚ÇÅ¬≥ 4 dx", options: ["4", "8", "12", "2"], correct: 1, explain: "4(3-1) = 8" },
            { q: "‚à´‚ÇÄ¬π (x^2+1) dx", options: ["1/3", "2/3", "4/3", "2"], correct: 2, explain: "1/3 + 1 = 4/3" },
            { q: "‚à´ 10x^9 dx", options: ["x^10 + C", "90x^8", "10x^10", "x^9"], correct: 0, explain: "x^10" },
            { q: "‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ï‡πâ y=x ‡∏à‡∏≤‡∏Å 0-4", options: ["4", "8", "16", "2"], correct: 1, explain: "16/2 = 8" },
            { q: "‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ï‡πâ y=x^2 ‡∏à‡∏≤‡∏Å 0-3", options: ["3", "9", "27", "6"], correct: 1, explain: "27/3 = 9" },
            { q: "‚à´ (6x^2+2x) dx", options: ["2x^3+x^2+C", "6x^3+2x^2", "3x^3", "x^3"], correct: 0, explain: "2x^3 + x^2" },
            { q: "‚à´ 1/x^2 dx", options: ["-1/x + C", "1/x", "ln x^2", "-2/x^3"], correct: 0, explain: "-x^-1" },
            { q: "‚à´ 3‚àöx dx", options: ["2x^1.5 + C", "x^1.5", "3x^0.5", "2x^2"], correct: 0, explain: "2x^1.5" },
            { q: "‚à´‚ÇÅ¬≤ 6x^2 dx", options: ["7", "14", "18", "21"], correct: 1, explain: "2(8-1) = 14" },
            { q: "‚à´ sec^2 x dx", options: ["tan x + C", "sin x", "cos x", "sec x"], correct: 0, explain: "‡πÑ‡∏î‡πâ tan" },
            { q: "‚à´ (e^x+x) dx", options: ["e^x+x^2/2+C", "e^x+x", "xe^x", "e^x+1"], correct: 0, explain: "‡πÅ‡∏¢‡∏Å‡∏û‡∏à‡∏ô‡πå" },
            { q: "‚à´‚ÇÄ^œÄ sin x dx", options: ["0", "1", "2", "-1"], correct: 2, explain: "-(-1)-(-1) = 2" },
            { q: "‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà y=4 ‡∏à‡∏≤‡∏Å x=1-5", options: ["4", "16", "20", "5"], correct: 1, explain: "4*4=16" },
            { q: "‚à´ (x+1)^2 dx", options: ["(x+1)^3/3+C", "x^2+2x+1", "x^2/2+x", "2x+2"], correct: 0, explain: "u-substitution" },
            { q: "‚à´ 1/(2‚àöx) dx", options: ["‚àöx + C", "2‚àöx", "1/x", "x"], correct: 0, explain: "d/dx(‚àöx)" },
            { q: "‚à´ (x^3-x) dx", options: ["x^4/4-x^2/2+C", "x^4-x^2", "3x^2-1", "x^4/4"], correct: 0, explain: "‡πÅ‡∏¢‡∏Å‡∏û‡∏à‡∏ô‡πå" },
            { q: "‚à´‚ÇÄ¬π (4x^3-1) dx", options: ["0", "1", "2", "-1"], correct: 0, explain: "1-1=0" },
            { q: "‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà y=4-x^2 (0-2)", options: ["16/3", "8/3", "4", "2"], correct: 0, explain: "8-8/3 = 16/3" }
        ];

        let shuffled = []; let current = 0; let combo = 0;
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        function playSnd(f, t, d) {
            const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
            o.type = t; o.frequency.setValueAtTime(f, audioCtx.currentTime);
            o.connect(g); g.connect(audioCtx.destination);
            g.gain.setValueAtTime(0.1, audioCtx.currentTime);
            o.start(); o.stop(audioCtx.currentTime + d);
        }

        // ‡∏£‡∏∞‡∏ö‡∏ö QR Code
        function openShare() {
            document.getElementById('share-overlay').style.display = 'flex';
            const url = window.location.href;
            document.getElementById('current-url').innerText = url;
            document.getElementById('qrcode').innerHTML = ""; // ‡∏•‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ô‡πÄ‡∏Å‡πà‡∏≤
            new QRCode(document.getElementById("qrcode"), {
                text: url, width: 200, height: 200,
                colorDark : "#0f0524", colorLight : "#ffffff"
            });
        }

        function closeShare() { document.getElementById('share-overlay').style.display = 'none'; }

        function copyLink() {
            navigator.clipboard.writeText(window.location.href);
            alert("‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏Ñ‡∏±‡∏°‡∏†‡∏µ‡∏£‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
        }

        function startGame() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            shuffled = [...rawQuestions].sort(() => Math.random() - 0.5);
            document.getElementById('start-screen').style.display = 'none';
            current = 0; combo = 0;
            initLadder(); loadQuestion();
        }

        function initLadder() {
            const p = document.getElementById('ladder-panel'); p.innerHTML = '';
            for(let i=1; i<=30; i++) {
                const d = document.createElement('div'); d.className='step'; d.id=`s-${i}`; d.innerText=`‡∏ä‡∏±‡πâ‡∏ô ${i}`; p.appendChild(d);
            }
        }

        function loadQuestion() {
            if(current >= 30) { win(); return; }
            const data = shuffled[current];
            document.getElementById('q-text').innerText = data.q;
            document.getElementById('level-label').innerText = `‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà: ${current+1}/30`;
            document.getElementById('streak-label').innerText = `Combo: ${combo}`;
            const b = document.getElementById('options-box'); b.innerHTML = '';
            data.options.forEach((o, i) => {
                const btn = document.createElement('button'); btn.className='opt-btn'; btn.innerText=o;
                btn.onclick = () => {
                    if(i === data.correct) {
                        playSnd(600, 'sine', 0.2); current++; combo++; loadQuestion();
                    } else {
                        playSnd(150, 'sawtooth', 0.4);
                        document.getElementById('quiz-card').classList.add('shake');
                        setTimeout(()=>document.getElementById('quiz-card').classList.remove('shake'), 400);
                        document.getElementById('correct-ans').innerText = `‡πÄ‡∏â‡∏•‡∏¢: ${data.options[data.correct]}`;
                        document.getElementById('explanation').innerText = data.explain;
                        document.getElementById('modal-overlay').style.display='flex';
                        if(current>0) current--; combo=0;
                    }
                };
                b.appendChild(btn);
            });
            document.querySelectorAll('.step').forEach(s=>s.classList.remove('active'));
            const active = document.getElementById(`s-${current+1}`);
            if(active) { active.classList.add('active'); active.scrollIntoView({behavior:'smooth', block:'center'}); }
        }

        function closeModal() { document.getElementById('modal-overlay').style.display='none'; loadQuestion(); }

        function win() {
            confetti({particleCount:150, spread:70});
            document.getElementById('main-game').innerHTML = `
                <div class="quiz-card">
                    <h1 style="color:var(--gold)">üèÜ ‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö!</h1>
                    <p>‡∏ó‡πà‡∏≤‡∏ô‡∏Ñ‡∏∑‡∏≠‡∏°‡∏´‡∏≤‡∏à‡∏≠‡∏°‡πÄ‡∏ß‡∏ó‡πÅ‡∏Ñ‡∏•‡∏Ñ‡∏π‡∏•‡∏±‡∏™</p>
                    <button class="btn-magic" onclick="openShare()">‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡∏Ñ‡∏±‡∏°‡∏†‡∏µ‡∏£‡πå (‡πÅ‡∏ä‡∏£‡πå)</button>
                    <button class="btn-magic" onclick="location.reload()">‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà</button>
                </div>
            `;
        }
    </script>
</body>
</html>